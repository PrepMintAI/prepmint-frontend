rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get the authenticated user's UID
    function getUserId() {
      return request.auth.uid;
    }

    // Get the authenticated user's role from token claims
    function getUserRole() {
      return request.auth.token.role;
    }

    // Get the authenticated user's institution ID from token claims
    function getUserInstitutionId() {
      return request.auth.token.institutionId;
    }

    // Check if user is the owner of a resource
    function isOwner(userId) {
      return isAuthenticated() && getUserId() == userId;
    }

    // Check if user has admin role
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    // Check if user has teacher role
    function isTeacher() {
      return isAuthenticated() && getUserRole() == 'teacher';
    }

    // Check if user has institution role
    function isInstitution() {
      return isAuthenticated() && getUserRole() == 'institution';
    }

    // Check if user has student role
    function isStudent() {
      return isAuthenticated() && getUserRole() == 'student';
    }

    // Check if user belongs to a specific institution
    function belongsToInstitution(institutionId) {
      return isAuthenticated() && getUserInstitutionId() == institutionId;
    }

    // Check if the role field is being modified (prevent role escalation)
    function roleNotChanged() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
    }

    // Validate that critical fields are not tampered with
    function criticalFieldsNotChanged() {
      return !request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['role', 'uid', 'createdAt']);
    }

    // ============================================================================
    // USERS COLLECTION: /users/{uid}
    // ============================================================================
    match /users/{uid} {
      // Users can read their own profile
      // Teachers can read student profiles (checked via backend/custom logic)
      // Admins can read any profile
      allow read: if isOwner(uid) || isAdmin() || isTeacher();

      // Users can create their own profile during signup
      allow create: if isOwner(uid)
        && request.resource.data.uid == uid
        && request.resource.data.email == request.auth.token.email;

      // Users can update their own profile, but NOT their role
      // Admins can update any profile
      allow update: if (isOwner(uid) && criticalFieldsNotChanged())
        || isAdmin();

      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // ============================================================================
    // INSTITUTIONS COLLECTION: /institutions/{institutionId}
    // ============================================================================
    match /institutions/{institutionId} {
      // Users can read their own institution
      // Institution admins can read their institution
      // System admins can read any institution
      allow read: if belongsToInstitution(institutionId)
        || isInstitution()
        || isAdmin();

      // Only system admins can create institutions
      allow create: if isAdmin();

      // Institution admins can update their own institution
      // System admins can update any institution
      allow update: if (isInstitution() && belongsToInstitution(institutionId))
        || isAdmin();

      // Only system admins can delete institutions
      allow delete: if isAdmin();
    }

    // ============================================================================
    // EVALUATIONS COLLECTION: /evaluations/{evaluationId}
    // ============================================================================
    match /evaluations/{evaluationId} {
      // Students can read their own evaluations
      // Teachers can read evaluations (backend validates assignment)
      // Admins can read all evaluations
      allow read: if isOwner(resource.data.userId)
        || isTeacher()
        || isAdmin();

      // Students can create evaluations for themselves
      allow create: if isStudent()
        && request.resource.data.userId == getUserId()
        && request.resource.data.keys().hasAll(['userId', 'subject', 'status']);

      // Teachers can update evaluations (add feedback, scores, update status)
      // Students CANNOT update evaluations after creation
      // Admins can update any evaluation
      allow update: if isTeacher() || isAdmin();

      // Only admins can delete evaluations
      allow delete: if isAdmin();
    }

    // ============================================================================
    // TESTS COLLECTION: /tests/{testId}
    // ============================================================================
    match /tests/{testId} {
      // Teachers can read their own tests
      // Students can read tests (backend validates class membership)
      // Admins can read all tests
      allow read: if isAuthenticated();

      // Teachers can create tests
      allow create: if isTeacher()
        && request.resource.data.createdBy == getUserId();

      // Teachers can update their own tests
      // Admins can update any test
      allow update: if (isTeacher() && resource.data.createdBy == getUserId())
        || isAdmin();

      // Teachers can delete their own tests
      // Admins can delete any test
      allow delete: if (isTeacher() && resource.data.createdBy == getUserId())
        || isAdmin();
    }

    // ============================================================================
    // SUBJECTS COLLECTION: /subjects/{subjectId}
    // ============================================================================
    match /subjects/{subjectId} {
      // All authenticated users can read subjects
      allow read: if isAuthenticated();

      // Teachers and admins can create subjects
      allow create: if isTeacher() || isAdmin();

      // Teachers can update subjects they created
      // Admins can update any subject
      allow update: if (isTeacher() && resource.data.createdBy == getUserId())
        || isAdmin();

      // Only admins can delete subjects
      allow delete: if isAdmin();
    }

    // ============================================================================
    // BADGES COLLECTION: /badges/{badgeId}
    // ============================================================================
    match /badges/{badgeId} {
      // All authenticated users can read badges (for display purposes)
      allow read: if isAuthenticated();

      // Only admins can create/update/delete badge definitions
      allow write: if isAdmin();
    }

    // ============================================================================
    // ACTIVITY COLLECTION: /activity/{activityId}
    // ============================================================================
    match /activity/{activityId} {
      // Users can read their own activity
      // Admins can read all activity
      allow read: if isOwner(resource.data.userId) || isAdmin();

      // Activity is written by backend/admin SDK (server-side)
      // Users can create activity for themselves
      allow create: if isOwner(request.resource.data.userId);

      // No updates allowed (activity is immutable)
      allow update: if false;

      // Only admins can delete activity
      allow delete: if isAdmin();
    }

    // ============================================================================
    // LEADERBOARDS COLLECTION: /leaderboards/{leaderboardId}
    // ============================================================================
    match /leaderboards/{leaderboardId} {
      // All authenticated users can read leaderboards
      allow read: if isAuthenticated();

      // Leaderboards are managed by backend/admin SDK
      // Only admins can write to leaderboards
      allow write: if isAdmin();
    }

    // ============================================================================
    // JOB QUEUES COLLECTION: /jobQueues/{jobId}
    // For AI evaluation job tracking
    // ============================================================================
    match /jobQueues/{jobId} {
      // Users can read their own jobs
      // Teachers can read jobs for their evaluations
      // Admins can read all jobs
      allow read: if isOwner(resource.data.userId)
        || isTeacher()
        || isAdmin();

      // Users can create jobs for themselves
      allow create: if isOwner(request.resource.data.userId);

      // Backend/cloud functions update job status
      // Only admins can manually update jobs
      allow update: if isAdmin();

      // Only admins can delete jobs
      allow delete: if isAdmin();
    }

    // ============================================================================
    // NOTIFICATIONS COLLECTION: /notifications/{notificationId}
    // User notifications and alerts
    // ============================================================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isOwner(resource.data.userId);

      // System (backend) creates notifications
      // Users can create notifications for themselves
      allow create: if isOwner(request.resource.data.userId) || isAdmin();

      // Users can update their own notifications (mark as read)
      allow update: if isOwner(resource.data.userId);

      // Users can delete their own notifications
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // ============================================================================
    // DEFAULT DENY RULE
    // ============================================================================
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
