rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get the authenticated user's UID
    function getUserId() {
      return request.auth.uid;
    }

    // Get the authenticated user's role from token claims
    function getUserRole() {
      return request.auth.token.role;
    }

    // Get the authenticated user's institution ID from token claims
    function getUserInstitutionId() {
      return request.auth.token.institutionId;
    }

    // Check if user is the owner of a resource
    function isOwner(userId) {
      return isAuthenticated() && getUserId() == userId;
    }

    // Check if user has admin role
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    // Check if user has teacher role
    function isTeacher() {
      return isAuthenticated() && getUserRole() == 'teacher';
    }

    // Check if user has institution role
    function isInstitution() {
      return isAuthenticated() && getUserRole() == 'institution';
    }

    // Check if user has student role
    function isStudent() {
      return isAuthenticated() && getUserRole() == 'student';
    }

    // Check if user has dev role (full access for development/testing)
    function isDev() {
      return isAuthenticated() && getUserRole() == 'dev';
    }

    // Check if user belongs to a specific institution
    function belongsToInstitution(institutionId) {
      return isAuthenticated() && getUserInstitutionId() == institutionId;
    }

    // Check if the role field is being modified (prevent role escalation)
    function roleNotChanged() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
    }

    // SECURITY FIX: Validate that critical fields are not tampered with
    // Protected fields: role, uid, createdAt, xp, level, badges, streak
    // These can ONLY be modified by admins/devs or through backend logic
    function criticalFieldsNotChanged() {
      return !request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['role', 'uid', 'createdAt', 'xp', 'level', 'badges', 'streak', 'institutionId']);
    }

    // Check if user is only modifying allowed profile fields
    // Students can update: displayName, photoURL, preferences, lastActive
    // They CANNOT update: role, xp, level, badges, streak, institutionId
    function onlyAllowedFieldsChanged() {
      let allowedFields = ['displayName', 'photoURL', 'lastActive', 'updatedAt', 'preferences'];
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
    }

    // ============================================================================
    // USERS COLLECTION: /users/{uid}
    // ============================================================================
    match /users/{uid} {
      // Users can read their own profile
      // Teachers can read student profiles (checked via backend/custom logic)
      // Admins can read any profile
      // Devs have full read access
      allow read: if isOwner(uid) || isAdmin() || isTeacher() || isDev();

      // Users can create their own profile during signup
      // Devs can create any profile
      allow create: if (isOwner(uid)
        && request.resource.data.uid == uid
        && request.resource.data.email == request.auth.token.email)
        || isDev();

      // SECURITY FIX: Users can update ONLY non-critical fields
      // Students CANNOT modify: role, xp, level, badges, streak, institutionId, uid, createdAt
      // Admins can update any profile
      // Devs can update any profile
      allow update: if (isOwner(uid) && onlyAllowedFieldsChanged())
        || isAdmin()
        || isDev();

      // Only admins and devs can delete users
      allow delete: if isAdmin() || isDev();
    }

    // ============================================================================
    // INSTITUTIONS COLLECTION: /institutions/{institutionId}
    // ============================================================================
    match /institutions/{institutionId} {
      // Users can read their own institution
      // Institution admins can read their institution
      // System admins can read any institution
      // Devs have full read access
      allow read: if belongsToInstitution(institutionId)
        || isInstitution()
        || isAdmin()
        || isDev();

      // Only system admins and devs can create institutions
      allow create: if isAdmin() || isDev();

      // Institution admins can update their own institution
      // System admins can update any institution
      // Devs can update any institution
      allow update: if (isInstitution() && belongsToInstitution(institutionId))
        || isAdmin()
        || isDev();

      // Only system admins and devs can delete institutions
      allow delete: if isAdmin() || isDev();
    }

    // ============================================================================
    // EVALUATIONS COLLECTION: /evaluations/{evaluationId}
    // ============================================================================
    match /evaluations/{evaluationId} {
      // Students can read their own evaluations
      // Teachers can read evaluations (backend validates assignment)
      // Admins can read all evaluations
      // Devs have full read access
      allow read: if isOwner(resource.data.userId)
        || isTeacher()
        || isAdmin()
        || isDev();

      // Students can create evaluations for themselves
      // Devs can create any evaluation
      allow create: if (isStudent()
        && request.resource.data.userId == getUserId()
        && request.resource.data.keys().hasAll(['userId', 'subject', 'status']))
        || isDev();

      // Teachers can update evaluations (add feedback, scores, update status)
      // Students CANNOT update evaluations after creation
      // Admins can update any evaluation
      // Devs can update any evaluation
      allow update: if isTeacher() || isAdmin() || isDev();

      // Only admins and devs can delete evaluations
      allow delete: if isAdmin() || isDev();
    }

    // ============================================================================
    // TESTS COLLECTION: /tests/{testId}
    // ============================================================================
    match /tests/{testId} {
      // Teachers can read their own tests
      // Students can read tests (backend validates class membership)
      // Admins can read all tests
      // Devs have full read access
      allow read: if isAuthenticated();

      // Teachers can create tests
      // Devs can create any test
      allow create: if (isTeacher()
        && request.resource.data.createdBy == getUserId())
        || isDev();

      // Teachers can update their own tests
      // Admins can update any test
      // Devs can update any test
      allow update: if (isTeacher() && resource.data.createdBy == getUserId())
        || isAdmin()
        || isDev();

      // Teachers can delete their own tests
      // Admins can delete any test
      // Devs can delete any test
      allow delete: if (isTeacher() && resource.data.createdBy == getUserId())
        || isAdmin()
        || isDev();
    }

    // ============================================================================
    // SUBJECTS COLLECTION: /subjects/{subjectId}
    // ============================================================================
    match /subjects/{subjectId} {
      // All authenticated users can read subjects
      allow read: if isAuthenticated();

      // Teachers and admins can create subjects
      // Devs can create any subject
      allow create: if isTeacher() || isAdmin() || isDev();

      // Teachers can update subjects they created
      // Admins can update any subject
      // Devs can update any subject
      allow update: if (isTeacher() && resource.data.createdBy == getUserId())
        || isAdmin()
        || isDev();

      // Only admins and devs can delete subjects
      allow delete: if isAdmin() || isDev();
    }

    // ============================================================================
    // BADGES COLLECTION: /badges/{badgeId}
    // ============================================================================
    match /badges/{badgeId} {
      // All authenticated users can read badges (for display purposes)
      allow read: if isAuthenticated();

      // Only admins and devs can create/update/delete badge definitions
      allow write: if isAdmin() || isDev();
    }

    // ============================================================================
    // ACTIVITY COLLECTION: /activity/{activityId}
    // ============================================================================
    match /activity/{activityId} {
      // Users can read their own activity
      // Admins can read all activity
      // Devs have full read access
      allow read: if isOwner(resource.data.userId) || isAdmin() || isDev();

      // Activity is written by backend/admin SDK (server-side)
      // Users can create activity for themselves
      // Devs can create any activity
      allow create: if isOwner(request.resource.data.userId) || isDev();

      // No updates allowed (activity is immutable)
      // Devs can update for testing purposes
      allow update: if isDev();

      // Only admins and devs can delete activity
      allow delete: if isAdmin() || isDev();
    }

    // ============================================================================
    // LEADERBOARDS COLLECTION: /leaderboards/{leaderboardId}
    // ============================================================================
    match /leaderboards/{leaderboardId} {
      // All authenticated users can read leaderboards
      allow read: if isAuthenticated();

      // Leaderboards are managed by backend/admin SDK
      // Only admins and devs can write to leaderboards
      allow write: if isAdmin() || isDev();
    }

    // ============================================================================
    // JOB QUEUES COLLECTION: /jobQueues/{jobId}
    // For AI evaluation job tracking
    // ============================================================================
    match /jobQueues/{jobId} {
      // Users can read their own jobs
      // Teachers can read jobs for their evaluations
      // Admins can read all jobs
      // Devs have full read access
      allow read: if isOwner(resource.data.userId)
        || isTeacher()
        || isAdmin()
        || isDev();

      // Users can create jobs for themselves
      // Devs can create any job
      allow create: if isOwner(request.resource.data.userId) || isDev();

      // Backend/cloud functions update job status
      // Only admins and devs can manually update jobs
      allow update: if isAdmin() || isDev();

      // Only admins and devs can delete jobs
      allow delete: if isAdmin() || isDev();
    }

    // ============================================================================
    // NOTIFICATIONS COLLECTION: /notifications/{notificationId}
    // User notifications and alerts
    // ============================================================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      // Devs have full read access
      allow read: if isOwner(resource.data.userId) || isDev();

      // System (backend) creates notifications
      // Users can create notifications for themselves
      // Devs can create any notification
      allow create: if isOwner(request.resource.data.userId) || isAdmin() || isDev();

      // Users can update their own notifications (mark as read)
      // Devs can update any notification
      allow update: if isOwner(resource.data.userId) || isDev();

      // Users can delete their own notifications
      // Devs can delete any notification
      allow delete: if isOwner(resource.data.userId) || isAdmin() || isDev();
    }

    // ============================================================================
    // DEFAULT DENY RULE
    // ============================================================================
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
