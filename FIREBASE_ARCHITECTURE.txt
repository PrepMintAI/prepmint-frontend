================================================================================
PREPMINT FIREBASE ARCHITECTURE DIAGRAM
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                            CLIENT-SIDE (BROWSER)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      React Components & Pages                         │  │
│  │  ┌─────────────────────┬──────────────┬────────────────────────┐    │  │
│  │  │  Auth Pages         │   Dashboards │   Common Components     │    │  │
│  │  │  - Login            │   - Student  │   - Card               │    │  │
│  │  │  - Register         │   - Teacher  │   - Button             │    │  │
│  │  │  - Verify Email     │   - Admin    │   - Spinner            │    │  │
│  │  │                     │   - Inst.    │                        │    │  │
│  │  └─────────────────────┴──────────────┴────────────────────────┘    │  │
│  │                                │                                      │  │
│  │                                ▼                                      │  │
│  │  ┌──────────────────────────────────────────────────────────────┐   │  │
│  │  │            AuthContext (Global Auth State)                   │   │  │
│  │  │  - useAuth() hook                                            │   │  │
│  │  │  - user: UserProfile (merged Firebase + Firestore)         │   │  │
│  │  │  - loading: boolean                                         │   │  │
│  │  │  - firebaseUser: Raw Firebase Auth user                    │   │  │
│  │  └──────────────────────────────────────────────────────────────┘   │  │
│  │                    │                            │                      │  │
│  │                    ▼                            ▼                      │  │
│  │  ┌──────────────────────────┐  ┌──────────────────────────────────┐  │  │
│  │  │  Custom Hooks            │  │  Core Libraries                  │  │  │
│  │  │  ─────────────────────── │  │  ──────────────────────────────  │  │  │
│  │  │  useFirestoreCRUD()      │  │  firebase.client.ts              │  │  │
│  │  │  - CRUD ops             │  │  - auth instance                 │  │  │
│  │  │  - Pagination           │  │  - db instance (Firestore)      │  │  │
│  │  │  - Real-time listeners  │  │  - Multi-tab sync               │  │  │
│  │  │                          │  │  - Cache recovery               │  │  │
│  │  │  useEvaluationPoll()     │  │                                  │  │  │
│  │  │  - Job status polling    │  │  api.ts (Axios)                 │  │  │
│  │  │  - Exponential backoff   │  │  - uploadForEvaluation()        │  │  │
│  │  │                          │  │  - getEvaluationStatus()        │  │  │
│  │  │  usePrefersReducedMotion │  │  - withCredentials: true        │  │  │
│  │  └──────────────────────────┘  │                                  │  │  │
│  │                  │              │  gamify.ts                       │  │  │
│  │                  │              │  - awardXp()                    │  │  │
│  │                  │              │  - awardBadge()                │  │  │
│  │                  │              │  - calculateLevel()             │  │  │
│  │                  │              │  - levelProgress()              │  │  │
│  │                  │              └──────────────────────────────────┘  │  │
│  │                  │                               │                    │  │
│  └──────────────────┼───────────────────────────────┼────────────────────┘  │
│                     │ (useCallback, useState)       │                        │
│                     │ Real-time updates             │ (direct reads)         │
│                     ▼                               ▼                        │
│        ┌─────────────────────────────────────────────────────────┐         │
│        │           Firebase Client SDK (v12.2.1)                 │         │
│        │  ┌─────────────────────┬──────────────────────────────┐ │         │
│        │  │  Auth Module        │  Firestore Module           │ │         │
│        │  │  - signUp()         │  - collection()             │ │         │
│        │  │  - signIn()         │  - query(), where()         │ │         │
│        │  │  - signOut()        │  - getDocs(), onSnapshot()  │ │         │
│        │  │  - getIdToken()     │  - addDoc(), updateDoc()    │ │         │
│        │  │  - onAuthStateChanged                             │ │         │
│        │  │  - Google Sign-In   │  - writeBatch()             │ │         │
│        │  │                     │  - runTransaction()         │ │         │
│        │  └─────────────────────┴──────────────────────────────┘ │         │
│        └─────────────────────────────────────────────────────────┘         │
│                             │                                              │
│                             ▼                                              │
│        ┌─────────────────────────────────────────────────────────┐         │
│        │           IndexedDB (Local Persistence)                 │         │
│        │  - Multi-tab synchronization                            │         │
│        │  - Offline support                                      │         │
│        │  - Cache auto-recovery on errors                        │         │
│        └─────────────────────────────────────────────────────────┘         │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                    │
                 HTTP/HTTPS (JSON-RPC Protocol)
                                    │
┌──────────────────────────────────────────────────────────────────────────────┐
│                           SERVER-SIDE (NEXT.JS)                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                     Next.js 15 App Router                            │   │
│  │  ┌────────────────────────────────────────────────────────────────┐ │   │
│  │  │ Server Components (Protected Pages)                             │ │   │
│  │  │ /dashboard/admin, /dashboard/student, etc.                      │ │   │
│  │  │  ├─ Verify __session cookie                                     │ │   │
│  │  │  ├─ Get user from adminDb().collection('users')               │ │   │
│  │  │  ├─ Check role authorization                                   │ │   │
│  │  │  └─ Pass userId to client component                            │ │   │
│  │  └────────────────────────────────────────────────────────────────┘ │   │
│  │  ┌────────────────────────────────────────────────────────────────┐ │   │
│  │  │ Middleware (src/middleware.ts)                                  │ │   │
│  │  │  ├─ Check __session cookie existence                            │ │   │
│  │  │  ├─ Redirect unauthenticated to /login                          │ │   │
│  │  │  └─ Apply security headers (CSP, HSTS, etc.)                   │ │   │
│  │  └────────────────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                         API Routes (/api)                            │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │ /api/auth/session (POST/DELETE)                              │   │   │
│  │  │  POST: Create httpOnly __session cookie from ID token        │   │   │
│  │  │  DELETE: Remove session (logout)                             │   │   │
│  │  │  Calls: adminAuth().createSessionCookie()                    │   │   │
│  │  │         adminDb().collection('users').doc(uid).get()        │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │ /api/auth/set-claims (POST)                                  │   │   │
│  │  │  Sets custom claims for role-based access control           │   │   │
│  │  │  Calls: adminAuth().setCustomUserClaims()                   │   │   │
│  │  │         adminDb().collection('users').doc(uid).update()     │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │ /api/gamify/xp (POST)                                         │   │   │
│  │  │  Award XP to user (transactional)                             │   │   │
│  │  │  Calls: adminDb().runTransaction()                           │   │   │
│  │  │    └─ Read user, update XP, log activity atomically         │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │ /api/gamify/badges (POST)                                    │   │   │
│  │  │  Award badge to user (transaction-safe)                      │   │   │
│  │  │  Calls: adminDb().runTransaction()                           │   │   │
│  │  │    └─ Check & add badge atomically (prevent duplicates)     │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │ /api/admin/users (POST)                                      │   │   │
│  │  │  Create users (admin-only)                                   │   │   │
│  │  │  Calls: adminAuth().createUser()                             │   │   │
│  │  │         adminDb().collection('users').doc(uid).set()        │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │ /api/role (GET/POST)                                         │   │   │
│  │  │  GET: Return current user's role                             │   │   │
│  │  │  POST: Update user role (admin-only)                         │   │   │
│  │  │  Calls: adminDb().collection('users').doc(uid).get()        │   │   │
│  │  │         adminDb().collection('users').doc(uid).set()        │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  │  All routes verify: __session cookie → adminAuth().verify() → role  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                 │                                            │
│                                 ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │         Firebase Admin SDK (v13.5.0) - Server-Only                   │   │
│  │  ┌────────────────────┬──────────────────────────────────────────┐   │   │
│  │  │  firebase.admin.ts │  Factory Functions                       │   │   │
│  │  │                    │  ─────────────────────────────────────  │   │   │
│  │  │  adminAuth()       │  export function adminAuth(): Auth      │   │   │
│  │  │  adminDb()         │  export function adminDb(): Firestore   │   │   │
│  │  │                    │                                          │   │   │
│  │  │  Helper Functions  │  ✓ Verify tokens                        │   │   │
│  │  │  ─────────────────│  ✓ Create users                          │   │   │
│  │  │  setUserClaims()   │  ✓ Delete users                          │   │   │
│  │  │  updateUserRole()  │  ✓ Award XP/Badges (transactional)     │   │   │
│  │  │  awardXpServer()   │  ✓ Set custom claims                    │   │   │
│  │  │  awardBadgeServer()│  ✓ Run transactions                      │   │   │
│  │  │  verifyUserRole()  │  ✓ Revoke tokens                         │   │   │
│  │  └────────────────────┴──────────────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                 │                                            │
│                                 ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Session Cookie Management (httpOnly)                                │   │
│  │  ┌────────────────────────────────────────────────────────────────┐  │   │
│  │  │ cookieStore.set('__session', sessionCookie, {                  │  │   │
│  │  │   httpOnly: true,     ◄─ JavaScript cannot access              │  │   │
│  │  │   secure: true,       ◄─ HTTPS only in production              │  │   │
│  │  │   sameSite: 'lax',    ◄─ CSRF protection                       │  │   │
│  │  │   path: '/',                                                   │  │   │
│  │  │   maxAge: 604800      ◄─ 7-day expiration                      │  │   │
│  │  │ })                                                             │  │   │
│  │  └────────────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                 │                                            │
└────────────────────────────────────────────────────────────────────────────────┘
                                 │
                    HTTPS (GRPC Protocol)
                                 │
┌────────────────────────────────────────────────────────────────────────────────┐
│                        FIREBASE BACKEND (GCP)                                  │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐   │
│  │                    Firebase Authentication                             │   │
│  │  - Email/Password auth                                                │   │
│  │  - Google Sign-In                                                     │   │
│  │  - Custom Claims storage                                              │   │
│  │  - Session validation                                                 │   │
│  │  - Token generation & verification                                    │   │
│  └────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐   │
│  │                       Firestore Database                               │   │
│  │  ┌──────────┬──────────┬──────────┬───────────┬────────┐              │   │
│  │  │ users    │ inst.    │ eval.    │ tests     │ subjects              │   │
│  │  │ (12 idx) │ (2 idx)  │ (4 idx)  │ (2 idx)   │ (2 idx) ...          │   │
│  │  └──────────┴──────────┴──────────┴───────────┴────────┘              │   │
│  │                                                                        │   │
│  │  Collections Protected by Security Rules:                             │   │
│  │  ┌────────────────────────────────────────────────────────────────┐  │   │
│  │  │ /users/{uid}           ◄─ Role, XP, Badges, Profile          │  │   │
│  │  │ /institutions/{id}     ◄─ Organization data                   │  │   │
│  │  │ /evaluations/{id}      ◄─ Student submissions                │  │   │
│  │  │ /tests/{id}            ◄─ Test definitions                    │  │   │
│  │  │ /subjects/{id}         ◄─ Subject definitions                 │  │   │
│  │  │ /badges/{id}           ◄─ Badge metadata                      │  │   │
│  │  │ /activity/{id}         ◄─ Activity audit log                 │  │   │
│  │  │ /leaderboards/{id}     ◄─ Global rankings                     │  │   │
│  │  │ /jobQueues/{id}        ◄─ AI evaluation jobs                 │  │   │
│  │  │ /notifications/{id}    ◄─ User notifications                 │  │   │
│  │  └────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                        │   │
│  │  Security Rules (277 lines):                                         │   │
│  │  ┌────────────────────────────────────────────────────────────────┐  │   │
│  │  │ Helper Functions:                                              │  │   │
│  │  │ ├─ isAuthenticated()                                           │  │   │
│  │  │ ├─ getUserRole() [from custom claims]                         │  │   │
│  │  │ ├─ isOwner(userId)                                            │  │   │
│  │  │ ├─ isAdmin() / isTeacher() / isStudent() / isDev()           │  │   │
│  │  │ ├─ belongsToInstitution()                                     │  │   │
│  │  │ ├─ criticalFieldsNotChanged()   [prevent tampering]           │  │   │
│  │  │ └─ onlyAllowedFieldsChanged()   [strict validation]           │  │   │
│  │  │                                                                 │  │   │
│  │  │ Document-Level Rules:                                         │  │   │
│  │  │ ├─ /users/{uid}: Owner read/write, Admin full access          │  │   │
│  │  │ ├─ /evaluations/{id}: Student own, Teacher edit              │  │   │
│  │  │ ├─ /tests/{id}: Teacher own, Student read                    │  │   │
│  │  │ ├─ /institutions/{id}: Institution admin, System admin       │  │   │
│  │  │ └─ /activity/{id}: Owner write, Backend updates              │  │   │
│  │  │                                                                 │  │   │
│  │  │ Field-Level Security:                                         │  │   │
│  │  │ ├─ Protected: role, uid, xp, level, badges, streak           │  │   │
│  │  │ └─ Allowed for students: displayName, photoURL, lastActive   │  │   │
│  │  └────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                        │   │
│  │  Composite Indexes (14 total):                                       │   │
│  │  ┌────────────────────────────────────────────────────────────────┐  │   │
│  │  │ evaluations:  userId+createdAt (0)                             │  │   │
│  │  │               userId+status+createdAt (1)                      │  │   │
│  │  │               teacherId+status+createdAt (2)                  │  │   │
│  │  │               institutionId+createdAt (3)                     │  │   │
│  │  │ activity:     userId+timestamp (4)                             │  │   │
│  │  │               userId+type+timestamp (5)                        │  │   │
│  │  │ tests:        createdBy+createdAt (6)                          │  │   │
│  │  │               institutionId+createdAt (7)                     │  │   │
│  │  │ notifications: userId+read+createdAt (8)                       │  │   │
│  │  │ jobQueues:    userId+status+createdAt (9)                     │  │   │
│  │  │ users:        institutionId+role (10)                          │  │   │
│  │  │               institutionId+xp (11)                            │  │   │
│  │  │               role+xp (12)                                     │  │   │
│  │  │               role+createdAt (13)                              │  │   │
│  │  └────────────────────────────────────────────────────────────────┘  │   │
│  └────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐   │
│  │                         GCP Infrastructure                             │   │
│  │  - Google Cloud Storage (future file uploads)                         │   │
│  │  - Cloud Functions (future: AI evaluation, notifications)            │   │
│  │  - Pub/Sub (future: async job processing)                            │   │
│  └────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└────────────────────────────────────────────────────────────────────────────────┘


================================================================================
DATA FLOW EXAMPLES
================================================================================

1. LOGIN FLOW
─────────────
Browser → signInWithEmailAndPassword() → Firebase Auth
         ↓
         ← Auth state change
         ↓
         getIdToken() → /api/auth/session (POST with idToken)
         ↓
         adminAuth().verifyIdToken() + adminAuth().createSessionCookie()
         ↓
         cookieStore.set('__session', cookie, { httpOnly, secure, sameSite })
         ↓
         AuthContext loads user profile from adminDb().collection('users')
         ↓
         Redirect to /dashboard/{role}

2. AWARD XP FLOW (Transactional)
────────────────────────────────
Dashboard Button Click → awardXp(userId, amount, reason)
         ↓
         POST /api/gamify/xp with authorization
         ↓
         adminAuth().verifySessionCookie(cookie) → Get current user
         ↓
         adminDb().runTransaction() {
           READ: user doc (get current XP)
           CALCULATE: newXp = currentXp + amount, newLevel = sqrt(newXp/100)+1
           UPDATE: user.xp, user.level (ATOMIC)
           CREATE: activity log entry (ATOMIC)
         }
         ↓
         Response: { newXp, newLevel }
         ↓
         Client updates UI

3. REAL-TIME DASHBOARD UPDATE
──────────────────────────────
useFirestoreCRUD({ collectionName: 'evaluations', realtime: true })
         ↓
         onSnapshot(query) → Firestore real-time listener
         ↓
         Document change detected
         ↓
         Update state → Re-render component
         ↓
         User sees new/updated evaluations in real-time

4. PROTECTED PAGE ACCESS
─────────────────────────
Browser → /dashboard/admin
         ↓
         Middleware checks __session cookie
         ↓
         No cookie? Redirect to /login
         ↓
         Has cookie → Allow through
         ↓
         Server component verifies cookie
         ↓
         adminAuth().verifySessionCookie() → Get UID
         ↓
         adminDb().collection('users').doc(uid).get() → Get user data
         ↓
         Check user.role === 'admin'
         ↓
         Wrong role? Redirect to /dashboard/{role}
         ↓
         Right role? Render page with userId prop

================================================================================
MIGRATION IMPACT SUMMARY
================================================================================

HIGH IMPACT (Requires Complete Rewrite):
  ✗ firebase.client.ts → supabase client init
  ✗ firebase.admin.ts → supabase admin client
  ✗ Firestore → PostgreSQL (schema redesign)
  ✗ Security Rules → Row-Level Security
  ✗ Custom Claims → JWT payload

MEDIUM IMPACT (Significant Changes):
  ~ AuthContext → Similar structure, different auth mechanism
  ~ useFirestoreCRUD → PostgreSQL query hook
  ~ Real-time listeners → Supabase Realtime subscriptions
  ~ Transactions → Database transactions

LOW IMPACT (Minor Changes):
  ≈ API routes → Keep structure, update calls
  ≈ Session cookies → Keep pattern, possibly simplify
  ≈ React components → No changes needed (data flow stays same)
  ≈ Middleware → Keep pattern, update verification logic

================================================================================
